<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>钢琴音准训练器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.5s ease;
        }

        /* 默认主题（蓝色） */
        body.default-theme {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2, #80deea);
            color: #333;
        }

        /* 粉色主题 */
        body.pink-theme {
            background: linear-gradient(135deg, #f8bbd0, #f48fb1, #f06292);
            color: #5d4037;
        }

        /* 暗色主题 */
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50, #1a237e, #0d47a1);
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(128, 222, 234, 0.3);
            backdrop-filter: blur(10px);
            margin-top: 20px;
        }

        body.dark-theme .container {
            background: rgba(30, 30, 46, 0.85);
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.3);
        }

        body.pink-theme .container {
            box-shadow: 0 10px 30px rgba(240, 98, 146, 0.3);
        }

        /* 主题切换按钮样式 */
        .theme-switcher {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        #themeToggle {
            color: white;
            border: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            min-width: 100px;
        }

        /* 默认主题按钮样式 */
        body.default-theme #themeToggle {
            background: linear-gradient(to right, #4db6ac, #00838f);
        }

        /* 粉色主题按钮样式 */
        body.pink-theme #themeToggle {
            background: linear-gradient(to right, #f8bbd0, #f48fb1);
        }

        /* 暗色主题按钮样式 */
        body.dark-theme #themeToggle {
            background: linear-gradient(to right, #3949ab, #1e88e5);
        }

        #themeToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* 通用样式 */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #00838f;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        body.pink-theme h1 {
            color: #d81b60;
        }

        body.dark-theme h1 {
            color: #64b5f6;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #4db6ac;
            max-width: 600px;
            margin: 0 auto;
        }

        body.pink-theme .subtitle {
            color: #f06292;
        }

        body.dark-theme .subtitle {
            color: #90caf9;
        }
        
        .status-message {
            text-align: center;
            margin-top: 10px;
            color: #00838f;
            font-weight: bold;
            min-height: 24px;
            padding: 10px;
            background: rgba(178, 235, 242, 0.3);
            border-radius: 10px;
        }

        body.pink-theme .status-message {
            background: rgba(248, 187, 208, 0.3);
            color: #d81b60;
        }

        body.dark-theme .status-message {
            background: rgba(57, 73, 171, 0.3);
            color: #90caf9;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px;
            border-radius: 15px;
            min-width: 200px;
            box-shadow: 0 4px 10px rgba(0, 131, 143, 0.1);
            background: rgba(255, 255, 255, 0.7);
        }

        body.pink-theme .control-group {
            background: rgba(255, 255, 255, 0.75);
        }

        body.dark-theme .control-group {
            background: rgba(45, 45, 66, 0.7);
        }

        .control-label {
            font-size: 1rem;
            color: #00838f;
            font-weight: bold;
        }

        body.pink-theme .control-label {
            color: #d81b60;
        }

        body.dark-theme .control-label {
            color: #90caf9;
        }

        input[type="number"], select {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #b2dfdb;
            background: rgba(255, 255, 255, 0.9);
            color: #004d40;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s;
        }

        body.pink-theme input[type="number"],
        body.pink-theme select {
            border-color: #f8bbd0;
        }

        body.dark-theme input[type="number"],
        body.dark-theme select {
            background: rgba(55, 55, 75, 0.9);
            color: #e0e0e0;
            border-color: #3949ab;
        }

        input[type="number"]:focus, select:focus {
            border-color: #4db6ac;
            outline: none;
            box-shadow: 0 0 8px rgba(77, 182, 172, 0.4);
        }

        .knob-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
        }
        
        .knob-label {
            font-size: 1rem;
            color: #00838f;
            font-weight: bold;
            margin-bottom: 8px;
        }

        body.pink-theme .knob-label {
            color: #d81b60;
        }

        body.dark-theme .knob-label {
            color: #90caf9;
        }
        
        .knob {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e0f7fa, #b2ebf2);
            box-shadow: 0 8px 20px rgba(128, 222, 234, 0.3),
                        inset 0 2px 4px rgba(255, 255, 255, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .knob:hover {
            transform: scale(1.05);
        }
        
        .knob-inner {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #f0fdff, #d5f5fa);
            box-shadow: inset 0 2px 8px rgba(128, 222, 234, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .knob-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00838f;
            text-shadow: 0 0 5px rgba(178, 235, 242, 0.8);
        }

        body.pink-theme .knob-value {
            color: #d81b60;
        }

        body.dark-theme .knob-value {
            color: #90caf9;
        }
        
        .knob-indicator {
            position: absolute;
            width: 4px;
            height: 30px;
            background: #4db6ac;
            top: -10px;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(0deg);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(77, 182, 172, 0.8);
        }

        body.pink-theme .knob-indicator {
            background: #f48fb1;
        }

        body.dark-theme .knob-indicator {
            background: #3949ab;
        }
        
        .knob-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 10px;
        }
        
        .knob-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(to bottom, #80cbc4, #4db6ac);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        body.pink-theme .knob-btn {
            background: linear-gradient(to bottom, #f8bbd0, #f48fb1);
        }

        body.dark-theme .knob-btn {
            background: linear-gradient(to bottom, #3949ab, #1e88e5);
        }
        
        .knob-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .piano-container {
            position: relative;
            height: 200px;
            margin: 30px 0;
            overflow-x: auto;
            padding-bottom: 20px;
            border-radius: 15px;
            box-shadow: inset 0 0 20px rgba(128, 222, 234, 0.3);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x;
        }

        body.pink-theme .piano-container {
            box-shadow: inset 0 0 20px rgba(240, 98, 146, 0.3);
        }

        body.dark-theme .piano-container {
            box-shadow: inset 0 0 20px rgba(33, 150, 243, 0.3);
        }

        .piano {
            position: relative;
            display: inline-flex;
            height: 180px;
            min-width: max-content;
            margin: 10px auto;
        }

        .key {
            position: relative;
            cursor: pointer;
            border-radius: 0 0 8px 8px;
            transition: all 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .white {
            width: 40px;
            height: 180px;
            background: linear-gradient(to bottom, #fff 0%, #f5f5f5 100%);
            border: 1px solid #e0e0e0;
            z-index: 1;
        }

        .white:hover {
            background: linear-gradient(to bottom, #f0f0f0 0%, #e5e5e5 100%);
        }

        .black {
            width: 26px;
            height: 110px;
            background: linear-gradient(to bottom, #455a64 0%, #37474f 100%);
            margin: 0 -13px;
            z-index: 2;
        }

        .black:hover {
            background: linear-gradient(to bottom, #546e7a 0%, #455a64 100%);
        }

        .selected {
            box-shadow: 0 0 15px rgba(255, 183, 77, 0.6);
        }
        
        .playing {
            background: linear-gradient(to bottom, #64b5f6, #2196f3) !important;
        }

        .selected.white {
            background: linear-gradient(to bottom, #fff9c4 0%, #fff176 100%);
        }

        .selected.black {
            background: linear-gradient(to bottom, #ffd54f 0%, #ffb300 100%);
        }

        .key-label {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: #455a64;
        }

        .black .key-label {
            color: #fff;
            bottom: 8px;
        }

        .selected .key-label {
            color: #e65100;
            font-weight: bold;
        }
        
        .key-label.hidden {
            display: none;
        }
        
        .position-indicator {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #e65100;
            text-shadow: 0 0 3px #fff;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(77, 182, 172, 0.4);
            font-weight: bold;
            letter-spacing: 1px;
            min-width: 180px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(77, 182, 172, 0.6);
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            background: linear-gradient(to right, #b0bec5, #90a4ae);
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        .random-btn {
            background: linear-gradient(to right, #81d4fa, #4fc3f7);
        }
        
        .toggle-labels-btn {
            background: linear-gradient(to right, #a5d6a7, #81c784);
        }
        
        .playback-btn {
            background: linear-gradient(to right, #90caf9, #64b5f6);
        }

        body.pink-theme .random-btn {
            background: linear-gradient(to right, #f8bbd0, #f48fb1);
        }

        body.pink-theme .toggle-labels-btn {
            background: linear-gradient(to right, #f48fb1, #f06292);
        }

        body.pink-theme .playback-btn {
            background: linear-gradient(to right, #f48fb1, #ec407a);
        }

        body.dark-theme .random-btn {
            background: linear-gradient(to right, #5e35b1, #3949ab);
        }

        body.dark-theme .toggle-labels-btn {
            background: linear-gradient(to right, #00897b, #00695c);
        }

        body.dark-theme .playback-btn {
            background: linear-gradient(to right, #1e88e5, #1565c0);
        }

        .selected-notes-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 30px 0;
        }

        .selected-notes {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }

        .note-display {
            border-radius: 12px;
            padding: 15px 20px;
            min-width: 100px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(128, 222, 234, 0.2);
            flex: 1;
            max-width: 120px;
            background: rgba(255, 255, 255, 0.7);
        }

        body.pink-theme .note-display {
            background: rgba(255, 255, 255, 0.75);
        }

        body.dark-theme .note-display {
            background: rgba(45, 45, 66, 0.7);
        }

        .note-number {
            font-size: 1rem;
            color: #00838f;
            margin-bottom: 5px;
        }

        body.pink-theme .note-number {
            color: #d81b60;
        }

        body.dark-theme .note-number {
            color: #90caf9;
        }
        
        .note-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #006064;
        }

        body.pink-theme .note-value {
            color: #ad1457;
        }

        body.dark-theme .note-value {
            color: #bb86fc;
        }
        
        .solfege-input-container {
            position: relative;
            margin-top: 8px;
            width: 100%;
        }
        
        .solfege-input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #b2dfdb;
            background: rgba(255, 255, 255, 0.9);
            color: #004d40;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
        }
        
        .solfege-input:focus {
            border-color: #4db6ac;
            outline: none;
            box-shadow: 0 0 8px rgba(77, 182, 172, 0.4);
        }
        
        .solfege-options {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0, 131, 143, 0.2);
            z-index: 10;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #b2dfdb;
        }
        
        .solfege-options.visible {
            display: block;
        }
        
        .solfege-option {
            padding: 8px;
            cursor: pointer;
            text-align: center;
            color: #004d40;
            transition: background 0.2s;
        }
        
        .solfege-option:hover {
            background: rgba(178, 235, 242, 0.4);
        }
        
        .solfege-option.custom {
            border-top: 1px solid #b2dfdb;
            font-style: italic;
        }

        body.pink-theme .solfege-input,
        body.pink-theme .solfege-options,
        body.pink-theme .solfege-option {
            border-color: #f8bbd0;
        }

        body.dark-theme .solfege-input,
        body.dark-theme .solfege-options,
        body.dark-theme .solfege-option {
            background: rgba(55, 55, 75, 0.9);
            color: #e0e0e0;
            border-color: #3949ab;
        }

        body.dark-theme .solfege-option:hover {
            background: rgba(66, 66, 86, 0.8);
        }

        .solfege-playback-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            box-shadow: 0 4px 10px rgba(0, 131, 143, 0.1);
            background: rgba(255, 255, 255, 0.7);
        }

        body.pink-theme .solfege-playback-container {
            background: rgba(255, 255, 255, 0.75);
        }

        body.dark-theme .solfege-playback-container {
            background: rgba(45, 45, 66, 0.7);
        }
        
        .solfege-playback-label {
            font-size: 1rem;
            color: #00838f;
            font-weight: bold;
            text-align: center;
        }

        body.pink-theme .solfege-playback-label {
            color: #d81b60;
        }

        body.dark-theme .solfege-playback-label {
            color: #90caf9;
        }
        
        .solfege-input-group {
            display: flex;
            gap: 10px;
        }
        
        .solfege-sequence-input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #b2dfdb;
            background: rgba(255, 255, 255, 0.9);
            color: #004d40;
            font-size: 1rem;
        }
        
        .solfege-sequence-input:focus {
            border-color: #4db6ac;
            outline: none;
            box-shadow: 0 0 8px rgba(77, 182, 172, 0.4);
        }

        body.pink-theme .solfege-sequence-input {
            border-color: #f8bbd0;
        }

        body.dark-theme .solfege-sequence-input {
            background: rgba(55, 55, 75, 0.9);
            color: #e0e0e0;
            border-color: #3949ab;
        }

        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9rem;
            color: #00838f;
        }

        body.pink-theme footer {
            color: #d81b60;
        }

        body.dark-theme footer {
            color: #90caf9;
        }

        /* 移动设备优化 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            button {
                padding: 12px 20px;
                min-width: 140px;
                font-size: 1rem;
            }
            
            .control-group {
                min-width: 150px;
            }
            
            .piano-container {
                height: 160px;
            }
            
            .white {
                width: 30px;
                height: 150px;
            }
            
            .black {
                width: 20px;
                height: 90px;
                margin: 0 -10px;
            }
            
            .note-display {
                max-width: 100px;
                padding: 10px 15px;
            }
            
            .key-label {
                font-size: 0.6rem;
            }
            
            .knob {
                width: 70px;
                height: 70px;
            }
            
            .knob-inner {
                width: 50px;
                height: 50px;
            }
            
            .solfege-playback-container {
                padding: 15px;
            }
            
            .solfege-input-group {
                flex-direction: column;
            }
            
            .button-group {
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .controls-container {
                flex-direction: column;
                align-items: center;
            }
            
            .control-group {
                width: 100%;
                max-width: 300px;
            }
            
            .knob-container {
                width: 100%;
                max-width: 300px;
            }
            
            .selected-notes {
                flex-direction: column;
                align-items: center;
            }
            
            .note-display {
                width: 100%;
                max-width: 250px;
            }
            
            .theme-switcher {
                position: static;
                margin-bottom: 15px;
            }
            
            #themeToggle {
                width: 100%;
            }
        }
    </style>
</head>
<body class="default-theme">
    <div class="container">
        <header>
            <div class="theme-switcher">
                <button id="themeToggle">切换主题</button>
            </div>
            <h1>钢琴音准训练器</h1>
            <p class="subtitle">选择音符数量，创建自定义训练序列</p>
        </header>
        
        <div class="status-message" id="statusMessage">正在加载音源...</div>
        
        <div class="controls-container">
            <div class="control-group">
                <label class="control-label" for="noteCount">音符数量 (1-25)</label>
                <input type="number" id="noteCount" min="1" max="25" value="3">
            </div>
            
            <div class="control-group">
                <label class="control-label" for="randomMode">随机播放模式</label>
                <select id="randomMode">
                    <option value="nonRepeat">不重复序列</option>
                    <option value="allowRepeat">允许重复序列</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label" for="randomSolfegeCount">随机唱名数量</label>
                <input type="number" id="randomSolfegeCount" min="1" max="25" value="3">
            </div>
        </div>

        <div class="controls-container">
            <div class="knob-container">
                <div class="knob-label">播放时长 (秒)</div>
                <div class="knob" id="durationKnob">
                    <div class="knob-inner">
                        <div class="knob-value" id="durationValue">0.8</div>
                        <div class="knob-indicator" id="durationIndicator"></div>
                    </div>
                </div>
                <div class="knob-controls">
                    <div class="knob-btn" id="durationDecrease">-</div>
                    <div class="knob-btn" id="durationIncrease">+</div>
                </div>
            </div>
            
            <div class="knob-container">
                <div class="knob-label">音量</div>
                <div class="knob" id="volumeKnob">
                    <div class="knob-inner">
                        <div class="knob-value" id="volumeValue">80%</div>
                        <div class="knob-indicator" id="volumeIndicator"></div>
                    </div>
                </div>
                <div class="knob-controls">
                    <div class="knob-btn" id="volumeDecrease">-</div>
                    <div class="knob-btn" id="volumeIncrease">+</div>
                </div>
            </div>
        </div>

        <div class="solfege-playback-container">
            <div class="solfege-playback-label">唱名序列点播</div>
            <div class="solfege-input-group">
                <input type="text" id="solfegeSequence" class="solfege-sequence-input" placeholder="输入唱名序列，如：do re mi">
                <button id="playbackBtn" class="playback-btn">点播</button>
            </div>
            <div class="solfege-playback-label">提示：输入唱名序列（用空格分隔），例如 "do re mi" 或 "sol la ti"</div>
        </div>
        
        <div class="selected-notes-container">
            <div class="selected-notes" id="selectedNotesContainer">
                <!-- 动态生成的音符显示区域 -->
            </div>
        </div>
        
        <div class="piano-container">
            <div class="piano" id="piano">
                <!-- 钢琴键通过JS动态生成 -->
            </div>
        </div>
        
        <div class="button-group">
            <button id="playBtn" disabled>播放序列</button>
            <button id="randomBtn" class="random-btn" disabled>随机播放</button>
            <button id="toggleLabelsBtn" class="toggle-labels-btn">隐藏音名</button>
            <button id="resetBtn">重置选择</button>
        </div>
    </div>
    
    <footer>
        <p>使用本地钢琴音源 | 音准训练工具</p>
    </footer>

    <script>
        // 主题切换功能
        const themeToggle = document.getElementById('themeToggle');
        const themes = ['default-theme', 'pink-theme', 'dark-theme'];
        let currentThemeIndex = 0;
        
        // 从localStorage加载保存的主题
        const savedTheme = localStorage.getItem('pianoTrainerTheme');
        if (savedTheme) {
            document.body.classList.add(savedTheme);
            currentThemeIndex = themes.indexOf(savedTheme);
        } else {
            document.body.classList.add(themes[0]);
        }
        
        // 更新按钮文本
        function updateThemeButtonText() {
            const themeNames = ['蓝色主题', '粉色主题', '暗色主题'];
            themeToggle.textContent = themeNames[currentThemeIndex];
        }
        
        updateThemeButtonText();
        
        // 切换主题
        themeToggle.addEventListener('click', () => {
            // 移除当前主题
            document.body.classList.remove(themes[currentThemeIndex]);
            
            // 切换到下一个主题
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            
            // 添加新主题
            document.body.classList.add(themes[currentThemeIndex]);
            
            // 保存到localStorage
            localStorage.setItem('pianoTrainerTheme', themes[currentThemeIndex]);
            
            // 更新按钮文本
            updateThemeButtonText();
        });

        // 新增：音效控制变量
        let noteDuration = 0.8; // 默认0.8秒
        let volumeLevel = 0.8;  // 默认80%音量 (0-1范围)

        const toggleLabelsBtn = document.getElementById('toggleLabelsBtn');
        let labelsVisible = true;
        
        // 切换音名显示/隐藏的函数
        function toggleKeyLabels() {
            const keyLabels = document.querySelectorAll('.key-label');
            keyLabels.forEach(label => {
                label.classList.toggle('hidden');
            });
            
            labelsVisible = !labelsVisible;
            toggleLabelsBtn.textContent = labelsVisible ? '隐藏音名' : '显示音名';
        }
        
        // 添加事件监听器
        toggleLabelsBtn.addEventListener('click', toggleKeyLabels);
        
        // 初始化Tone.js - 使用本地下载的音源
        const sampler = new Tone.Sampler({
            urls: {
                "C1": "C1.mp3",
                "A1": "A1.mp3",
                "C2": "C2.mp3",
                "A2": "A2.mp3",
                "C3": "C3.mp3",
                "A3": "A3.mp3",
                "C4": "C4.mp3",
                "A4": "A4.mp3",
                "C5": "C5.mp3",
                "A5": "A5.mp3",
                "C6": "C6.mp3",
                "A6": "A6.mp3"
            },
            baseUrl: "./",  
            onload: () => {
                console.log("本地钢琴音源加载完成");
                document.getElementById('statusMessage').textContent = "音源加载完成！";
                document.getElementById('playBtn').disabled = false;
                document.getElementById('randomBtn').disabled = false;
                
                // 设置初始音量
                sampler.volume.value = Tone.gainToDb(volumeLevel);
            },
            onerror: (error) => {
                console.error("音源加载错误:", error);
                document.getElementById('statusMessage').textContent = "音源加载失败，请检查控制台";
                
                // 如果是CORS错误，显示额外提示
                if (error.message.includes("Failed to fetch")) {
                    document.getElementById('statusMessage').innerHTML += 
                        "<br><span style='color:#ff5555'>请使用本地服务器运行（如VS Code的Live Server）！</span>";
                }
            }
        }).toDestination();
    
        // 获取DOM元素
        const piano = document.getElementById('piano');
        const playBtn = document.getElementById('playBtn');
        const randomBtn = document.getElementById('randomBtn');
        const resetBtn = document.getElementById('resetBtn');
        const noteCountInput = document.getElementById('noteCount');
        const randomModeSelect = document.getElementById('randomMode');
        const selectedNotesContainer = document.getElementById('selectedNotesContainer');
        const statusMessage = document.getElementById('statusMessage');
        // 新增：获取随机唱名数量输入框
        const randomSolfegeCountInput = document.getElementById('randomSolfegeCount');
        
        // 当前选中的音符
        let selectedNotes = ["A4", "B4", "F#4"];
        // 存储每个音符的唱名标签
        let solfegeLabels = {};
        let noteCount = 3;
        
        // 钢琴键盘配置 - 扩展到C1到B6（6个八度）
        const octaveStart = 1; // 从C1开始
        const octaveEnd = 6;   // 到B6结束
        const blackKeys = ["C#", "D#", "F#", "G#", "A#"];
        
        // 初始化函数
        function init() {
            createPiano();
            setupEventListeners();
            updateNoteCount(3); // 初始化为3个音符
            // 确保按钮文本正确
            toggleLabelsBtn.textContent = labelsVisible ? '隐藏音名' : '显示音名';
            
            // 初始化旋钮指示器位置
            updateKnobIndicators();
        }
        
        // 创建钢琴键盘
        function createPiano() {
            piano.innerHTML = '';
            
            for (let octave = octaveStart; octave <= octaveEnd; octave++) {
                for (let i = 0; i < 12; i++) {
                    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                    const note = notes[i];
                    const fullNote = note + octave;
                    const isBlack = blackKeys.includes(note);
                    
                    const key = document.createElement('div');
                    key.className = `key ${isBlack ? 'black' : 'white'}`;
                    key.dataset.note = fullNote;
                    
                    const label = document.createElement('div');
                    label.className = 'key-label';
                    label.textContent = fullNote;
                    key.appendChild(label);
                    
                    // 点击琴键时播放声音并选择音符
                    const handleKeyInteraction = async (e) => {
                        // 阻止触摸事件的默认行为（防止页面滚动）
                        if (e.type === 'touchstart') {
                            e.preventDefault();
                        }
                        
                        // 播放当前点击的音符
                        try {
                            // 确保音频上下文已启动
                            if (Tone.context.state !== 'running') {
                                // 尝试启动音频上下文
                                await Tone.start();
                                statusMessage.textContent = "音频上下文已启动！";
                            }
                            
                            // 添加播放效果
                            key.classList.add('playing');
                            setTimeout(() => key.classList.remove('playing'), 300);
                            
                            // 播放音符
                            sampler.triggerAttackRelease(fullNote, noteDuration);
                        } catch (error) {
                            console.error("播放错误:", error);
                            statusMessage.textContent = "播放错误：" + error.message;
                        }
                        
                        // 更新选择
                        if (!selectedNotes.includes(fullNote)) {
                            if (selectedNotes.length < noteCount) {
                                selectedNotes.push(fullNote);
                                updateSelectedNotesDisplay();
                                highlightSelectedKeys();
                            } else {
                                statusMessage.textContent = `已达到最大选择数量 (${noteCount})`;
                                setTimeout(() => {
                                    if (selectedNotes.length === noteCount) {
                                        statusMessage.textContent = "";
                                    }
                                }, 2000);
                            }
                        }
                    };
                    
                    // 同时支持鼠标点击和触摸事件
                    key.addEventListener('click', handleKeyInteraction);
                    key.addEventListener('touchstart', handleKeyInteraction);
                    
                    piano.appendChild(key);
                }
            }
            
            highlightSelectedKeys();
            updateSelectedNotesDisplay();
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            playBtn.addEventListener('click', playSequence);
            randomBtn.addEventListener('click', playRandomSequence);
            resetBtn.addEventListener('click', resetSelection);
            
            // 点播按钮事件监听
            document.getElementById('playbackBtn').addEventListener('click', playSolfegeSequence);
            
            // 音符数量变化监听
            noteCountInput.addEventListener('change', () => {
                const newCount = parseInt(noteCountInput.value);
                if (newCount >= 1 && newCount <= 25) {
                    updateNoteCount(newCount);
                } else {
                    noteCountInput.value = noteCount;
                    statusMessage.textContent = "请输入1-25之间的数字";
                    setTimeout(() => statusMessage.textContent = "", 2000);
                }
            });
            
            // 防止输入非法值
            noteCountInput.addEventListener('input', () => {
                let value = parseInt(noteCountInput.value);
                if (isNaN(value) || value < 1) noteCountInput.value = 1;
                if (value > 25) noteCountInput.value = 25;
            });
            
            // 随机唱名数量输入验证
            randomSolfegeCountInput.addEventListener('input', () => {
                let value = parseInt(randomSolfegeCountInput.value);
                if (isNaN(value) || value < 1) randomSolfegeCountInput.value = 1;
                if (value > 25) randomSolfegeCountInput.value = 25;
            });
            
            // 播放时长旋钮事件监听
            const handleKnobInteraction = (e, knobId, setterFn, min, max) => {
                const knob = document.getElementById(knobId);
                const rect = knob.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                // 获取事件坐标（支持触摸事件）
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                if (!clientX || !clientY) return;
                
                // 计算角度 (0-360度)
                const angle = Math.atan2(clientY - centerY, clientX - centerX) * (180 / Math.PI);
                // 将角度转换为0-360范围
                const normalizedAngle = (angle + 360) % 360;
                
                // 将角度映射到指定范围
                const newValue = min + (normalizedAngle / 360) * (max - min);
                setterFn(newValue);
            };
            
            // 播放时长旋钮
            const durationKnob = document.getElementById('durationKnob');
            durationKnob.addEventListener('click', (e) => {
                handleKnobInteraction(e, 'durationKnob', setNoteDuration, 0.1, 2);
            });
            durationKnob.addEventListener('touchstart', (e) => {
                handleKnobInteraction(e, 'durationKnob', setNoteDuration, 0.1, 2);
            });
            
            // 音量旋钮
            const volumeKnob = document.getElementById('volumeKnob');
            volumeKnob.addEventListener('click', (e) => {
                handleKnobInteraction(e, 'volumeKnob', setVolume, 0, 1);
            });
            volumeKnob.addEventListener('touchstart', (e) => {
                handleKnobInteraction(e, 'volumeKnob', setVolume, 0, 1);
            });
            
            // 播放时长按钮事件监听
            document.getElementById('durationDecrease').addEventListener('click', () => {
                setNoteDuration(Math.max(0.1, noteDuration - 0.1));
            });
            
            document.getElementById('durationIncrease').addEventListener('click', () => {
                setNoteDuration(Math.min(2, noteDuration + 0.1));
            });
            
            // 音量按钮事件监听
            document.getElementById('volumeDecrease').addEventListener('click', () => {
                setVolume(Math.max(0, volumeLevel - 0.1));
            });
            
            document.getElementById('volumeIncrease').addEventListener('click', () => {
                setVolume(Math.min(1, volumeLevel + 0.1));
            });
        }
        
        // 设置播放时长
        function setNoteDuration(duration) {
            noteDuration = parseFloat(duration.toFixed(1));
            document.getElementById('durationValue').textContent = noteDuration.toFixed(1);
            updateKnobIndicators();
        }
        
        // 设置音量
        function setVolume(volume) {
            volumeLevel = parseFloat(volume.toFixed(1));
            document.getElementById('volumeValue').textContent = Math.round(volumeLevel * 100) + '%';
            
            // 设置Tone.js音量 (转换为分贝值)
            sampler.volume.value = Tone.gainToDb(volumeLevel);
            updateKnobIndicators();
        }
        
        // 更新旋钮指示器位置
        function updateKnobIndicators() {
            // 播放时长旋钮：0.1-2秒映射到0-360度
            const durationAngle = ((noteDuration - 0.1) / 1.9) * 360;
            document.getElementById('durationIndicator').style.transform = `translateX(-50%) rotate(${durationAngle}deg)`;
            
            // 音量旋钮：0-1映射到0-360度
            const volumeAngle = volumeLevel * 360;
            document.getElementById('volumeIndicator').style.transform = `translateX(-50%) rotate(${volumeAngle}deg)`;
        }

        // 更新音符数量
        function updateNoteCount(newCount) {
            noteCount = newCount;
            
            // 如果当前选择的音符数量超过新数量，截断数组
            if (selectedNotes.length > noteCount) {
                selectedNotes = selectedNotes.slice(0, noteCount);
            }
            
            // 重新生成音符显示区域
            generateNoteDisplays();
            updateSelectedNotesDisplay();
            highlightSelectedKeys();
        }
        
        // 生成音符显示区域
        function generateNoteDisplays() {
            selectedNotesContainer.innerHTML = '';
            
            for (let i = 0; i < noteCount; i++) {
                const noteDisplayElement = document.createElement('div');
                noteDisplayElement.className = 'note-display';
                noteDisplayElement.id = `noteDisplay${i}`;
                
                const noteNumber = document.createElement('div');
                noteNumber.className = 'note-number';
                noteNumber.textContent = `音符 ${i + 1}`;
                
                const noteValue = document.createElement('div');
                noteValue.className = 'note-value';
                noteValue.id = `displayNote${i}`;
                noteValue.textContent = selectedNotes[i] || "";
                
                // 创建唱名输入容器
                const solfegeContainer = document.createElement('div');
                solfegeContainer.className = 'solfege-input-container';
                
                // 创建唱名输入框
                const solfegeInput = document.createElement('input');
                solfegeInput.type = 'text';
                solfegeInput.className = 'solfege-input';
                solfegeInput.id = `solfegeInput${i}`;
                solfegeInput.placeholder = '输入唱名';
                solfegeInput.value = solfegeLabels[i] || '';
                
                // 创建唱名选项容器
                const solfegeOptions = document.createElement('div');
                solfegeOptions.className = 'solfege-options';
                
                // 默认唱名选项
                const defaultOptions = ['do', 're', 'mi', 'fa', 'sol', 'la', 'ti'];
                defaultOptions.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'solfege-option';
                    optionElement.textContent = option;
                    optionElement.dataset.value = option;
                    solfegeOptions.appendChild(optionElement);
                });
                
                // 将输入框和选项添加到容器
                solfegeContainer.appendChild(solfegeInput);
                solfegeContainer.appendChild(solfegeOptions);
                
                // 事件处理：点击输入框显示选项
                solfegeInput.addEventListener('click', function(e) {
                    e.stopPropagation();
                    solfegeOptions.classList.toggle('visible');
                });
                
                // 事件处理：选择选项
                solfegeOptions.addEventListener('click', function(e) {
                    if (e.target.classList.contains('solfege-option')) {
                        const value = e.target.dataset.value;
                        if (value === 'custom') {
                            // 自定义选项 - 保持输入框可编辑状态
                            solfegeInput.focus();
                        } else {
                            // 预设选项 - 设置值并隐藏选项
                            solfegeInput.value = value;
                            solfegeLabels[i] = value;
                        }
                        solfegeOptions.classList.remove('visible');
                    }
                });
                
                // 事件处理：输入框变化
                solfegeInput.addEventListener('change', function() {
                    solfegeLabels[i] = this.value;
                });
                
                // 事件处理：点击页面其他地方隐藏选项
                document.addEventListener('click', function(e) {
                    if (!solfegeContainer.contains(e.target)) {
                        solfegeOptions.classList.remove('visible');
                    }
                });
                
                noteDisplayElement.appendChild(noteNumber);
                noteDisplayElement.appendChild(noteValue);
                noteDisplayElement.appendChild(solfegeContainer);
                selectedNotesContainer.appendChild(noteDisplayElement);
            }
        }
        
        // 高亮选中的琴键
        function highlightSelectedKeys() {
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('selected');
                const positionIndicator = key.querySelector('.position-indicator');
                if (positionIndicator) {
                    positionIndicator.remove();
                }
            });
            
            selectedNotes.forEach((note, index) => {
                const key = document.querySelector(`.key[data-note="${note}"]`);
                if (key) {
                    key.classList.add('selected');
                    
                    // 添加位置指示器
                    const positionIndicator = document.createElement('div');
                    positionIndicator.className = 'position-indicator';
                    positionIndicator.textContent = index + 1;
                    key.appendChild(positionIndicator);
                }
            });
        }
        
        // 更新选中的音符显示
        function updateSelectedNotesDisplay() {
            for (let i = 0; i < noteCount; i++) {
                const displayElement = document.getElementById(`displayNote${i}`);
                if (displayElement) {
                    displayElement.textContent = selectedNotes[i] || "";
                }
            }
        }
        
        // 播放音符序列
        async function playSequence() {
            if (selectedNotes.length === 0) {
                statusMessage.textContent = "请先选择至少一个音符";
                return;
            }
            
            if (selectedNotes.length < noteCount) {
                statusMessage.textContent = `请选择所有 ${noteCount} 个音符`;
                return;
            }
            
            playBtn.disabled = true;
            randomBtn.disabled = true;
            statusMessage.textContent = "正在播放序列...";
            
            try {
                // 确保音频上下文已启动
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    statusMessage.textContent = "音频上下文已启动，正在播放...";
                }
                
                // 依次播放选中的音符
                for (let i = 0; i < selectedNotes.length; i++) {
                    const note = selectedNotes[i];
                    
                    // 在播放前添加临时高亮效果
                    const key = document.querySelector(`.key[data-note="${note}"]`);
                    if (key) {
                        key.classList.add('playing');
                        setTimeout(() => key.classList.remove('playing'), 500);
                    }
                    
                    // 播放音符
                    sampler.triggerAttackRelease(note, noteDuration);
                    
                    // 更新当前播放状态（包含唱名标签）
                    const solfegeLabel = solfegeLabels[i] || "";
                    statusMessage.textContent = `正在播放 ${i+1}/${selectedNotes.length}: ${note} ${solfegeLabel ? `(${solfegeLabel})` : ''}`;
                    
                    // 等待音符结束
                    await new Promise(resolve => setTimeout(resolve, noteDuration * 1000));
                }
            } catch (error) {
                console.error("播放错误:", error);
                statusMessage.textContent = "播放失败：" + error.message;
            } finally {
                playBtn.disabled = false;
                randomBtn.disabled = false;
                statusMessage.textContent = "播放完成！";
                setTimeout(() => statusMessage.textContent = "", 2000);
            }
        }
        
        // 生成随机序列
        function generateRandomSequence() {
            if (selectedNotes.length === 0) {
                statusMessage.textContent = "请先选择至少一个音符";
                return null;
            }
            
            const mode = randomModeSelect.value;
            const sequence = [];
            
            if (mode === 'nonRepeat') {
                // 不重复序列：打乱已选音符的顺序
                const shuffled = [...selectedNotes];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            } else {
                // 允许重复序列：从已选音符中随机选择（允许重复）
                for (let i = 0; i < noteCount; i++) {
                    const randomIndex = Math.floor(Math.random() * selectedNotes.length);
                    sequence.push(selectedNotes[randomIndex]);
                }
                return sequence;
            }
        }
        
        // 修改playRandomSequence函数
        async function playRandomSequence() {
            // 获取用户输入的随机唱名数量n
            const n = parseInt(randomSolfegeCountInput.value);
            if (isNaN(n) || n < 1) {
                statusMessage.textContent = "请输入有效的随机唱名数量";
                return;
            }

            // 收集所有非空的唱名标签
            const allSolfege = [];
            for (let i = 0; i < noteCount; i++) {
                if (solfegeLabels[i] && solfegeLabels[i].trim() !== '') {
                    allSolfege.push(solfegeLabels[i].trim());
                }
            }

            if (allSolfege.length === 0) {
                statusMessage.textContent = "没有可用的唱名，请先输入唱名标签";
                return;
            }

            const mode = randomModeSelect.value;
            let randomSolfegeSequence = [];

            if (mode === 'nonRepeat') {
                // 不重复序列：要求n不超过唱名总数
                if (n > allSolfege.length) {
                    statusMessage.textContent = `不重复模式下，随机数量不能超过可用唱名数量（${allSolfege.length}）`;
                    return;
                }
                // 打乱数组
                const shuffled = [...allSolfege];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                randomSolfegeSequence = shuffled.slice(0, n);
            } else {
                // 允许重复序列
                for (let i = 0; i < n; i++) {
                    const randomIndex = Math.floor(Math.random() * allSolfege.length);
                    randomSolfegeSequence.push(allSolfege[randomIndex]);
                }
            }

            // 将随机选择的唱名序列填入唱名序列框
            document.getElementById('solfegeSequence').value = randomSolfegeSequence.join(' ');

            // 播放唱名序列
            await playSolfegeSequence();
        }

        // 重置选择
        function resetSelection() {
            selectedNotes = [];
            solfegeLabels = {};
            updateSelectedNotesDisplay();
            highlightSelectedKeys();
            generateNoteDisplays(); // 重新生成显示区域以重置唱名标签
            statusMessage.textContent = "选择已重置";
            setTimeout(() => statusMessage.textContent = "", 2000);
        }
    
        // 唱名到音符的映射关系
        const solfegeToNoteMap = {
            'do': 'C',
            're': 'D',
            'mi': 'E',
            'fa': 'F',
            'sol': 'G',
            'la': 'A',
            'ti': 'B',
            'si': 'B' // 兼容不同地区的唱名
        };
        
        // 播放唱名序列
        async function playSolfegeSequence() {
            const sequenceInput = document.getElementById('solfegeSequence').value.trim();
            if (!sequenceInput) {
                statusMessage.textContent = "请输入唱名序列";
                return;
            }
            
            // 分割唱名序列
            const solfegeSequence = sequenceInput.split(/\s+/);
            if (solfegeSequence.length === 0) {
                statusMessage.textContent = "请输入有效的唱名序列";
                return;
            }
            
            // 获取当前选择的音符
            if (selectedNotes.length === 0) {
                statusMessage.textContent = "请先选择至少一个音符";
                return;
            }
            
            // 创建唱名到音符的映射（基于用户设置）
            const solfegeNoteMap = {};
            for (let i = 0; i < selectedNotes.length; i++) {
                const solfege = solfegeLabels[i] || '';
                if (solfege) {
                    solfegeNoteMap[solfege.toLowerCase()] = selectedNotes[i];
                }
            }
            
            // 如果没有用户设置的唱名映射，使用默认映射
            const useDefaultMap = Object.keys(solfegeNoteMap).length === 0;
            
            // 播放序列
            playBtn.disabled = true;
            randomBtn.disabled = true;
            statusMessage.textContent = "正在播放唱名序列...";
            
            try {
                // 确保音频上下文已启动
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    statusMessage.textContent = "音频上下文已启动，正在播放唱名序列...";
                }
                
                // 依次播放唱名序列
                for (let i = 0; i < solfegeSequence.length; i++) {
                    const solfege = solfegeSequence[i].toLowerCase();
                    let noteToPlay = null;
                    
                    // 查找对应的音符
                    if (useDefaultMap) {
                        // 使用默认映射
                        const noteBase = solfegeToNoteMap[solfege];
                        if (noteBase) {
                            // 从当前选择的音符中查找匹配的音符
                            for (const note of selectedNotes) {
                                if (note.startsWith(noteBase)) {
                                    noteToPlay = note;
                                    break;
                                }
                            }
                        }
                    } else {
                        // 使用用户设置的映射
                        noteToPlay = solfegeNoteMap[solfege];
                    }
                    
                    if (!noteToPlay) {
                        statusMessage.textContent = `未找到唱名 "${solfege}" 对应的音符，跳过`;
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                    
                    // 在播放前添加临时高亮效果
                    const key = document.querySelector(`.key[data-note="${noteToPlay}"]`);
                    if (key) {
                        key.classList.add('playing');
                        setTimeout(() => key.classList.remove('playing'), 500);
                    }
                    
                    // 播放音符
                    sampler.triggerAttackRelease(noteToPlay, noteDuration);
                    
                    // 更新当前播放状态
                    statusMessage.textContent = `正在播放 ${i+1}/${solfegeSequence.length}: ${solfege} -> ${noteToPlay}`;
                    
                    // 等待音符结束
                    await new Promise(resolve => setTimeout(resolve, noteDuration * 1000));
                }
            } catch (error) {
                console.error("播放错误:", error);
                statusMessage.textContent = "播放失败：" + error.message;
            } finally {
                playBtn.disabled = false;
                randomBtn.disabled = false;
                statusMessage.textContent = "唱名序列播放完成！";
                setTimeout(() => statusMessage.textContent = "", 2000);
            }
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>